---
title: 3_Visualisation.ipynb
output: html_notebook
---

```{r, message=FALSE}
# load packages
library(vfbconnectr)
library(natverse)
library(dplyr)

# if Running on Rstudio server (==cloud) use plotly as visualisation default
#if(isTRUE(Sys.getenv('RSTUDIO_PROGRAM_MODE')=="server"))
options(nat.plotengine = 'plotly')
```

Set up connections to VFB APIs and VFB CATMAID server.

```{r}
# vfb_connect object
# vc = VfbConnect(neo_endpoint="http://pdb.p2.virtualflybrain.org")
vc = VfbConnect()
# Connect to the VFB CATMAID server hosting the FAFB data
catmaid::vfbcatmaid('fafb')
```


# Plotting
`nat` lets you plot neurons in 2d using, and in 3d using either `plotly` when
in a notebook environment or using a `rgl`-based 3D viewer when running on the
desktop. The `rgl` solution won't work in rstudio.cloud so we will focus on 2d
and `plotly` for 3d. See http://natverse.org/nat/articles/plotly.html for more details.

```{r}
# We'll use a FAFB neuron, retrieved using nat/rcatmaid as an example
# retrieves a CatMaid neuron object with skeleton id = 16 (See the Mapping notebook for how to find )
n = read.neuron.catmaid(16) 
n
```



```{r}
# We can plot this in 2D
plot(n)
```

```{r}
plot(n, WithNodes = F)
```
```{r}
plot(n, WithNodes = F, col='gold')
```


```{r}
nclear3d()
# Or 3D 
# FIXME plot3d.neuronlist works with plotly but not plot3d.neuron
plot3d(neuronlist(n), plotengine='plotly')
```

**Navigation:**

* left click and drag to rotate (select "Orbital rotation" above the legend to make your life easier)
* mousewheel to zoom
* right-mouse + drag to translate
* click legend items (single or double) to hide/unhide. (FIXME)

**Customization:**

The above plots are very basic examples but there are a ton of ways to tweak things to your liking.
For a full list of parameters check out the docs for plot and plot3d.

Let's for example change the colors. In general, colors can be:

a string - e.g. "red" or
an rgb/rgba tuple as hex e.g. "#FF0000". 

```{r}
plot3d(n, color='cyan')
```

#### Excercise

Float over the 

```{r}
# CATMAID neuron objects include connectors (synapses)  here pre-(red) and postsynapses (blue).
nclear3d()
plot3d(neuronlist(n), width=1000, connectors=TRUE, col='cyan', plotengine='plotly') #
```

Now let's try an example with multiple neurons

```{r}
# Pulling (annotations on) neurons from a single dataset on CATMAID

bates = pymaid.find_neurons(annotations='Paper: Bates and Schlegel et al 2020') 
# Viewing first 10 neurons:
bates[0:10]
```

```{r}
# Plotting multiple neurons, we get a default multi-color pallete

bates[0:10].plot3d(hover_name=True)

```

What if we want to use color to group neurons in some way?

The following example illustrates colouring by lineage, where lineage is derived from standardised neuron names on FAFB CATMAID 


```{r}
# On CATMAID, we need to know something about the structure of names and parse them to get types:

import re 
prog = re.compile("Uniglomerular(.*?) DA1 ")

# Match all neuron names in `bates` against that pattern
is_da1 = list(map(lambda x: prog.match(x) != None, bates.name))

# Subset list of neurons
da1 = bates[is_da1]
da1.head()
```

```{r}
# Add lineage attribute to all da1 neurons based on regex against name
for n in da1:
    # Split name into components and keep only the tract
    n.lineage = n.name.split(' ')[3]    

import seaborn as sns
import numpy as np 

# Get all unique lineages (we expect only two)
lineages = np.unique(da1.lineage) 

# Generate a color per lineage
lin_cmap = dict(zip(lineages, sns.color_palette('muted', len(lineages))))

# Make a dictionary mapping skid to colour appropriate to lineage
lineage_map = dict(zip(da1.id, da1.lineage)) 
neuron_cmap = {i: lin_cmap[l] for i, l in lineage_map.items()}

navis.plot3d(da1, color=neuron_cmap, legend_group=lineage_map, hover_name=True, width=1000)
```

We can do the same thing using VFB, looking up the relevant terms on the web site and then using these to categorise CATMAID neurons

```{r}
# With VFB, we can query by type

from vfb_connect.cross_server_tools import gen_short_form # TODO - make this arg on oc.get_instances

def vfb_type_2_skids(vfb_type):
    # Get IDs (short_forms) for instances of type
    da1_from_vfb = map(gen_short_form, vc$oc.get_instances(vfb_type, query_by_label=True))
    # Find which neurons are in catmaid_fafb and return 
    da1_skid_lookup = vc$neo_query_wrapper.vfb_id_2_xrefs(da1_from_vfb, db='catmaid_fafb', reverse_return=True)
    # Convert skids to ints 
    da1_skids = da1_skid_lookup.keys()
    return list(da1_skids)

da1_fafb = vfb_type_2_skids("'adult antennal lobe projection neuron DA1'")
da1_l_fafb = vfb_type_2_skids("'adult antennal lobe projection neuron DA1 lPN'")
da1_v_fafb = vfb_type_2_skids("'adult antennal lobe projection neuron DA1 vPN'")


is_da1 = list(map(lambda x: x in da1_fafb, bates.skeleton_id))
da1 = bates[is_da1]
```

```{r}
# Generate a palette 
palette = sns.color_palette('muted', 2)
# Make a dictionary 
lin_cmap = { 'lPN': palette[0], 'vPN': palette[1]}
```

```{r}
# Make a dictionary with key = skid & value = color by lineage
lineage_map = {n: 'lPN' for n in da1_l_fafb}
lineage_map.update({n: 'vPN' for n in da1_v_fafb})

neuron_cmap = {n: lin_cmap[l] for n, l in lineage_map.items()}

navis.plot3d(da1, color=neuron_cmap, hover_name=True, legend_group=lineage_map, width=1000)
```

VFB allows us to pull neurons from multiple sources and display them in a single template space

```{r}
DA1_manifest = vc$get_images_by_type("'adult antennal lobe projection neuron DA1'", template = 'JRC2018Unisex', image_folder = 'DA1', stomp=True)
```

```{r}
DA1_manifest[0:3]
```

We can then plot the neurons, coloring by data_source

```{r}
# Read skeletons from file
#nl = navis.read_swc('DA1') 

# The neuron names correspond to the filenames
# To make it easier, we will manually add IDs from the manifest
ids = dict(zip(DA1_manifest.filename.map(lambda x: x.replace('.swc', '')).values,
               DA1_manifest.accession.values)) 
for n in nl:
    n.id = ids[n.name]

# Add data source 
ds = DA1_manifest.set_index('accession').data_source.to_dict()
for n in nl:
    n.source = ds[n.id]
```

```{r}
source_cmap = dict(zip(np.unique(nl.source),
                       sns.color_palette('muted', len(np.unique(nl.source)))))

source_map = dict(zip(nl.id, nl.source))
neuron_cmap = {n.id: source_cmap[n.source] for n in nl}

navis.plot3d(nl, color=neuron_cmap, hover_name=True, legend_group=source_map, width=1000)
```

### Adding volumes

```{r}
# For a full list of volumes available on JRC2018Unisex, please see:
# https://v2.virtualflybrain.org/org.geppetto.frontend/geppetto?q=VFB_00101567,PaintedDomains

# Get an image (obj volume) of the mushroom body calyx on JRC2018Unisex: 

MB = vc$get_images_by_type("'mushroom body calyx'", template = 'JRC2018Unisex', image_folder='MB', image_type='obj', stomp=True) # TODO - check for man and pull if there.
MB
```

```{r}
# Plot this along with the neurons in the previous example
import trimesh

# TBA # discovery step

test = trimesh.load('MB/CA_on_JRC2018Unisex_adult_brain.obj')
mesh = navis.Volume(test)
mesh.color = (230, 230, 230, .2)
mesh.name = "ME on JRC2018Unisex adult brain"
navis.plot3d([mesh, nl], color=neuron_cmap, hover_name=True, legend_group=source_map)
```
